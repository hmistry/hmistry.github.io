<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>ActiveRecord vs Sequel Performance | Hiren Mistry</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="ActiveRecord vs Sequel Performance" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I ran some benchmarking tests to evaluate the performance difference, if any, between ActiveRecord and Sequel ORM’s - two common ORM’s in the Ruby world. I measured two sets of benchmarks: speed, and memory consumed. In addition, each set was measured against two different databases: SQLite3, and PostgreSQL. The results are summarized below." />
<meta property="og:description" content="I ran some benchmarking tests to evaluate the performance difference, if any, between ActiveRecord and Sequel ORM’s - two common ORM’s in the Ruby world. I measured two sets of benchmarks: speed, and memory consumed. In addition, each set was measured against two different databases: SQLite3, and PostgreSQL. The results are summarized below." />
<link rel="canonical" href="http://hmistry.github.io/software/2017/12/11/activerecord-vs-sequel.html" />
<meta property="og:url" content="http://hmistry.github.io/software/2017/12/11/activerecord-vs-sequel.html" />
<meta property="og:site_name" content="Hiren Mistry" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-12-11T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="ActiveRecord vs Sequel Performance" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2017-12-11T00:00:00+00:00","datePublished":"2017-12-11T00:00:00+00:00","description":"I ran some benchmarking tests to evaluate the performance difference, if any, between ActiveRecord and Sequel ORM’s - two common ORM’s in the Ruby world. I measured two sets of benchmarks: speed, and memory consumed. In addition, each set was measured against two different databases: SQLite3, and PostgreSQL. The results are summarized below.","headline":"ActiveRecord vs Sequel Performance","mainEntityOfPage":{"@type":"WebPage","@id":"http://hmistry.github.io/software/2017/12/11/activerecord-vs-sequel.html"},"url":"http://hmistry.github.io/software/2017/12/11/activerecord-vs-sequel.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://hmistry.github.io/feed.xml" title="Hiren Mistry" /><script>
if(!(window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-107875946-1', 'auto');
  ga('send', 'pageview');
}
</script>
  
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Hiren Mistry</a>

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
            <a class="page-link" href="/about/">About</a>
            
          
            
            
          
            
            
          
            
            
          

          
            <a class="page-link" href="https://github.com/hmistry"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span></a>

          

          
            <a class="page-link" href="https://twitter.com/hmistry0"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span></a>

          

          
            <a class="page-link" href="https://www.linkedin.com/in/hmistry2"><span class="icon icon--linkedin"><!-- https://simpleicons.org -->
<svg aria-labelledby="simpleicons-linkedin-icon" role="img" viewBox="0 0 24 24" width="16px" height="16px" xmlns="http://www.w3.org/2000/svg">
  <title id="simpleicons-linkedin-icon">LinkedIn icon</title>
  <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
</svg>
</span></a>

          

          <a class="page-link" href="/feed.xml"><span class="icon icon--rss"><!-- https://simpleicons.org -->
<svg aria-labelledby="simpleicons-rss-icon" role="img" viewBox="0 0 24 24" width="16px" height="16px" xmlns="http://www.w3.org/2000/svg">
  <title id="simpleicons-rss-icon">Subscribe to RSS</title>
  <path d="M19.199 24C19.199 13.467 10.533 4.8 0 4.8V0c13.165 0 24 10.835 24 24h-4.801zM3.291 17.415c1.814 0 3.293 1.479 3.293 3.295 0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526 0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727 0 15.909 7.184 15.909 15.91z"/>
</svg>
</span></a>

        </div>
      </nav>
    
  </div>
</header>


<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">ActiveRecord vs Sequel Performance</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2017-12-11T00:00:00+00:00" itemprop="datePublished">Dec 11, 2017
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I ran some benchmarking tests to evaluate the performance difference, if any, between ActiveRecord and Sequel ORM’s - two common ORM’s in the Ruby world. I measured two sets of benchmarks: speed, and memory consumed. In addition, each set was measured against two different databases: SQLite3, and PostgreSQL. The results are summarized below.
<!--more--></p>

<p id="updated-note"><strong>Updated:</strong> (2017-12-27) I updated the benchmarks to account for ActiveRecord lazily typecasting data on attribute access and Sequel typecasting immediately on retrieval from the database. For an apples-to-apples comparison, the benchmarks now force ActiveRecord to typecast the data so the total computation time and memory used is accounted for in the results for both ORM’s. I also added a set of benchmarks for Sequel with <code class="language-plaintext highlighter-rouge">sequel_pg</code> gem for PostgreSQL database - the <code class="language-plaintext highlighter-rouge">sequel_pg</code> gem replaces the Sequel postgres adapter row fetching and typecasting code with a C version that improves the performance.</p>
<p><br /></p>
<h4 id="contents">Contents:</h4>
<ul>
  <li><a href="#setup">Setup</a></li>
  <li><a href="#results">Results</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>

<p><br /></p>
<h2 id="setup">Setup</h2>
<ol>
  <li>All the tests were done on a local machine (2013 MacBook Pro) i.e. both the database and ruby script ran on the same machine for simplicity and time.</li>
  <li>Versions used: Ruby v2.4.2, ActiveRecord v5.1.4, Sequel v5.2.0, SQLite v3.16.0, and PostgreSQL v9.6.5.</li>
  <li>Used <code class="language-plaintext highlighter-rouge">benchmark-ips</code> and <code class="language-plaintext highlighter-rouge">memory_profiler</code> gems to obtain performance measurements.</li>
  <li>Ran the test on SQLite3 and PostgreSQL databases.</li>
  <li>The database schema had 3 models - Topic, Post, and Comment - with the following relations - topic has many posts and post has many comments. The database was seeded with 10 topics, 100 posts, and 20,000 comments.</li>
  <li>Both ORM’s were configured to write a log file like in a real world application. Logging did affect the speed - made it slower.</li>
  <li>Benchmark code is available on Github <a href="https://github.com/hmistry/ar_sql">here</a>.</li>
  <li>The tests are grouped as follows:
    <ol>
      <li>Loading the ORM</li>
      <li>Creating records</li>
      <li>Updating records</li>
      <li>Querying records</li>
      <li>Queries - Lazy typecasting &amp; Timestamps</li>
    </ol>
  </li>
</ol>

<p><br /></p>
<h2 id="results">Results:</h2>
<p>Things to note:</p>
<ul>
  <li>Speed performance - results are shown for both PostgreSQL and SQLite3 databases.</li>
  <li>Speed is measured in iterations per second, except load time which is in seconds. Higher is better for iterations per second and lower is better for seconds (load time).</li>
  <li>Memory usage performance - only results for PostgreSQL are shown because results for SQLite3 were very similar and did not offer much insights.</li>
  <li>Memory is measured in bytes and number of objects for memory allocated and retained (total of 4 measurements). Lower is better for memory allocation and retention.</li>
</ul>

<p><strong>Key:</strong><br />
AR =&gt; ActiveRecord gem v5.1.4<br />
Sql =&gt; Sequel gem v5.2.0<br />
Sql + sql_pg =&gt; Sequel gem v5.2.0 + Sequel_pg gem v1.8.1 (for PostgreSQL database only)<br /></p>

<p><br />
<strong>Tests:</strong><br /></p>
<ol>
  <li><a href="#loading">Loading the ORM</a></li>
  <li><a href="#creating">Creating records</a></li>
  <li><a href="#updating">Updating records</a></li>
  <li><a href="#querying">Querying records</a></li>
  <li><a href="#typecasting">Queries - Lazy typecasting &amp; Timestamps</a></li>
</ol>

<p><br /></p>
<h3 id="loading">1. Loading the ORM</h3>
<p>Sequel beats ActiveRecord by ~3x in both speed and memory in loading.</p>
<ul>
  <li>It loads in 0.1s vs 0.3s for ActiveRecord.</li>
  <li>It allocates 6Mb in memory vs 20Mb for ActiveRecord.</li>
  <li>It doesn’t defer any memory allocation to the first query run unlike ActiveRecord which defers further memory allocation of 200Kb to the first query run (after require). A typical ActiveRecord query is in the 10’s Kb (in this test scenario).</li>
</ul>

<p><br />
<strong>ORM Load Time</strong></p>

<p><img src="http://hmistry.github.io/assets/images/load-time.png" alt="Load Time" class="post-halfwidth-image" /></p>

<p><br />
<strong>ORM Memory Usage</strong></p>

<p><img src="http://hmistry.github.io/assets/images/load-mem.png" alt="Load Memory" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/load-obj.png" alt="Load Memory" class="post-halfwidth-image" /></p>

<p><br />
<strong>ActiveRecord First Run Memory Usage</strong>
<br />
The very first use of any ActiveRecord query (after require) allocates more memory than subsequent queries. This does not happen in Sequel.</p>

<p><img src="http://hmistry.github.io/assets/images/init-run-mem.png" alt="First Run Memory" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/init-run-obj.png" alt="First Run Memory" class="post-halfwidth-image" /></p>

<p><br /></p>
<h3 id="creating">2. Creating records</h3>
<p>Measured two aspects in creating a record - one without validations and the other with a presence validation.</p>
<ul>
  <li>There is little performance degradation due to the validation but this is a simple validation.</li>
</ul>

<p>Sequel performs better than ActiveRecord in both speed and memory for creating records.</p>
<ul>
  <li>It is 1.8x-2x faster for PostgreSQL and 1.2x faster for SQLite3.</li>
  <li>It’s memory allocation is lower and memory retention is significantly lower than ActiveRecord (see charts).</li>
</ul>

<p><br />
<strong>ORM Speed Performance</strong></p>

<p>Using PostgreSQL:</p>

<p><img src="http://hmistry.github.io/assets/images/create-pg-ips.png" alt="Load Time" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/create-val-pg-ips.png" alt="Load Time" class="post-halfwidth-image" /></p>

<p><br />
Using SQLite3:</p>

<p><img src="http://hmistry.github.io/assets/images/create-sq3-ips.png" alt="Load Time" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/create-val-sq3-ips.png" alt="Load Time" class="post-halfwidth-image" /></p>

<p><br />
<strong>ORM Memory Usage</strong></p>

<p>Using PostgreSQL:</p>

<p><img src="http://hmistry.github.io/assets/images/create-pg-mem.png" alt="Load Memory" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/create-pg-obj.png" alt="Load Memory" class="post-halfwidth-image" /></p>

<p><br />
<img src="http://hmistry.github.io/assets/images/create-val-pg-mem.png" alt="Load Memory" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/create-val-pg-obj.png" alt="Load Memory" class="post-halfwidth-image" /></p>

<p><br /></p>
<h3 id="updating">3. Updating records</h3>
<p>Measured two different methods of updating a record - one with a hash argument to update an attribute, and the other used method assignment then save to update the record.</p>
<ul>
  <li>There is little performance difference between the two update methodologies.</li>
</ul>

<p>Sequel performs better than ActiveRecord in both speed and memory for updating records.</p>
<ul>
  <li>It is 1.7x-2x faster.</li>
  <li>It’s memory allocation is less than half of ActiveRecord and memory retention is 6x-8x lower than ActiveRecord.</li>
</ul>

<p><br />
<strong>ORM Speed Performance</strong></p>

<p>Using PostgreSQL:</p>

<p><img src="http://hmistry.github.io/assets/images/update-pg-ips.png" alt="Load Time" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/update2-pg-ips.png" alt="Load Time" class="post-halfwidth-image" /></p>

<p><br />
Using SQLite3:</p>

<p><img src="http://hmistry.github.io/assets/images/update-sq3-ips.png" alt="Load Time" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/update2-sq3-ips.png" alt="Load Time" class="post-halfwidth-image" /></p>

<p><br />
<strong>ORM Memory Usage</strong></p>

<p>Using PostgreSQL:</p>

<p><img src="http://hmistry.github.io/assets/images/update-pg-mem.png" alt="Load Memory" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/update-pg-obj.png" alt="Load Memory" class="post-halfwidth-image" /></p>

<p><br />
<img src="http://hmistry.github.io/assets/images/update2-pg-mem.png" alt="Load Memory" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/update2-pg-obj.png" alt="Load Memory" class="post-halfwidth-image" /></p>

<p><br /></p>
<h3 id="querying">4. Querying records</h3>
<p>Querying records revealed some implementation differences in the ORM’s and added some complexity to the benchmarking. For an apples-to-apples comparison, these benchmarks force the ORM’s to typecast the data (if you missed the reason, see the <a href="#updated-note">updated note</a> above). Measured the following methods of querying the database (AR method / Sequel method):</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">#find(id) / #[id]</code></li>
  <li><code class="language-plaintext highlighter-rouge">#findby() / #find()</code></li>
  <li><code class="language-plaintext highlighter-rouge">#where()</code></li>
  <li><code class="language-plaintext highlighter-rouge">#first</code></li>
  <li>Eager load associated model, <code class="language-plaintext highlighter-rouge">#where().includes() / #where().eager()</code> (retrieves 1 + 100 records)</li>
  <li><code class="language-plaintext highlighter-rouge">#where().order()</code> query (retrieves 50 records)</li>
</ul>

<p>Sequel generally performed better than ActiveRecord in both speed and memory except for one query.</p>
<ul>
  <li>It is 1.1x-2x faster without <code class="language-plaintext highlighter-rouge">sequel_pg</code> except for one query where it is 20% slower.</li>
  <li>It’s memory allocation and retention is less than ActiveRecord in all but one query.</li>
  <li>Sequel with <code class="language-plaintext highlighter-rouge">sequel_pg</code> is 1.6x-3.8x faster than ActiveRecord.</li>
  <li>Sequel with <code class="language-plaintext highlighter-rouge">sequel_pg</code> is significantly lower in memory allocation and has similar, if not same, memory retention as sequel.</li>
</ul>

<p><br />
<strong>ORM Speed Performance</strong></p>

<p>Using PostgreSQL:</p>

<p><img src="http://hmistry.github.io/assets/images/find-pg-ips.png" alt="Load Time" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/findby-pg-ips.png" alt="Load Time" class="post-halfwidth-image" /></p>

<p><br />
<img src="http://hmistry.github.io/assets/images/where-pg-ips.png" alt="Load Time" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/first-pg-ips.png" alt="Load Time" class="post-halfwidth-image" /></p>

<p><br />
<img src="http://hmistry.github.io/assets/images/eager-pg-ips.png" alt="Load Time" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/postwo-pg-ips.png" alt="Load Time" class="post-halfwidth-image" /></p>

<p><br />
SQLite3 Results shown in next <a href="#typecasting">section #5</a>.</p>

<p><br />
<strong>ORM Memory Usage</strong></p>

<p>Using PostgreSQL:</p>

<p><img src="http://hmistry.github.io/assets/images/find-pg-mem.png" alt="Load Time" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/find-pg-obj.png" alt="Load Time" class="post-halfwidth-image" /></p>

<p><br />
<img src="http://hmistry.github.io/assets/images/findby-pg-mem.png" alt="Load Time" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/findby-pg-obj.png" alt="Load Time" class="post-halfwidth-image" /></p>

<p><br />
<img src="http://hmistry.github.io/assets/images/where-pg-mem.png" alt="Load Time" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/where-pg-obj.png" alt="Load Time" class="post-halfwidth-image" /></p>

<p><br />
<img src="http://hmistry.github.io/assets/images/first-pg-mem.png" alt="Load Time" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/first-pg-obj.png" alt="Load Time" class="post-halfwidth-image" /></p>

<p><br />
<img src="http://hmistry.github.io/assets/images/eager-pg-mem.png" alt="Load Time" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/eager-pg-obj.png" alt="Load Time" class="post-halfwidth-image" /></p>

<p><br />
<img src="http://hmistry.github.io/assets/images/postwo-pg-mem.png" alt="Load Time" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/postwo-pg-obj.png" alt="Load Time" class="post-halfwidth-image" /></p>

<p><br /></p>
<h3 id="typecasting">5. Queries - Lazy typecasting &amp; Timestamps</h3>
<p>These benchmarks explore:</p>
<ul>
  <li>ActiveRecord’s defered typecasting gain/impact on performance (measured the same queries as above - only SQLite3 ones are shown here).</li>
  <li>Typecasting timestamps are slow and is the cause of Sequel slower performance in the one query above.</li>
</ul>

<p>Lazy typecasting gain/impact:</p>
<ul>
  <li>Sequel has the same performance whether you force typecasting through attribute access or not.</li>
  <li>ActiveRecord shows a 10-50% reduction in speed due to deferred typecasting when you access the attribute data.</li>
  <li>It is interesting that even with this optimization, ActiveRecord still looses to Sequel in some queries.</li>
</ul>

<p>Retrieving timestamps impact:</p>
<ul>
  <li>The <code class="language-plaintext highlighter-rouge">#where().order()</code> query performance without retrieving timestamp data increases 1.9x for ActiveRecord and 5.8x for Sequel.</li>
  <li>The <code class="language-plaintext highlighter-rouge">#where().order()</code> query performance of retrieving the timestamp data only (nothing else) is close to retrieving the full record data for both ORM’s.</li>
  <li>This shows that the low performance of <code class="language-plaintext highlighter-rouge">#where().order()</code> query is correlated to retrieving timestamp data for the 50 records.</li>
</ul>

<p><br />
<strong>ORM query performance</strong></p>

<p>Using SQLite3:</p>

<p><img src="http://hmistry.github.io/assets/images/find-sq3-ips.png" alt="Load Time" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/findby-sq3-ips.png" alt="Load Time" class="post-halfwidth-image" /></p>

<p><br />
<img src="http://hmistry.github.io/assets/images/where-sq3-ips.png" alt="Load Time" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/first-sq3-ips.png" alt="Load Time" class="post-halfwidth-image" /></p>

<p><br />
<img src="http://hmistry.github.io/assets/images/eager-sq3-ips.png" alt="Load Time" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/postwo-sq3-ips.png" alt="Load Time" class="post-halfwidth-image" /></p>

<p><br />
<strong>Timestamps performance cost in <code class="language-plaintext highlighter-rouge">#where().order()</code> query</strong></p>

<p><br />
<img src="http://hmistry.github.io/assets/images/postwo-sq3-ips.png" alt="Load Time" class="post-halfwidth-image post-halfwidth-image-left" />
<img src="http://hmistry.github.io/assets/images/postwo2-sq3-ips.png" alt="Load Time" class="post-halfwidth-image" /></p>

<p><br /></p>
<h2 id="conclusion">Conclusion:</h2>
<p>Summarizing the benchmark results:</p>
<ul>
  <li>In loading, Sequel beats ActiveRecord by ~3x in speed and memory.</li>
  <li>In creating new records, Sequel performs 1.2x-2x better than ActiveRecord in speed and uses less memory.</li>
  <li>In updating records, Sequel performs 1.7x-2x better than ActiveRecord in speed and uses less than half the memory.</li>
  <li>In querying:
    <ul>
      <li>Sequel without <code class="language-plaintext highlighter-rouge">sequel_pg</code> is 1.1x-2x faster than ActiveRecord except for one query where it is 20% slower.</li>
      <li>Sequel memory allocation and retention is less than ActiveRecord in all but one query.</li>
      <li>Sequel with <code class="language-plaintext highlighter-rouge">sequel_pg</code> is 1.6x-3.8x faster than ActiveRecord.</li>
      <li>Sequel with <code class="language-plaintext highlighter-rouge">sequel_pg</code> is significantly lower in memory allocation and has similar, if not same, memory retention as sequel (which is lower than ActiveRecord).</li>
      <li>Retrieving timestamp data can impact speed performance significantly for both ORM’s.</li>
    </ul>
  </li>
</ul>

<p>In conclusion, the overall performance of Sequel is much better than ActiveRecord both in speed and memory usage by a good margin. The lower memory usage also helps to reduce garbage collection overhead in an application. I liked the fact Sequel does not defer some object allocation when loading the library, and it immediately typecasts the data on retrieval when querying. This means once the query is executed, the data is ready for consumption. A side note on querying - typecasting timestamps are slow so consider excluding it when retrieving records from the database for performance critical queries. Lastly, I was quite impressed with the significant performance boost of Sequel with the <code class="language-plaintext highlighter-rouge">sequel_pg</code> addon used with PostgreSQL databases - it’s definitely a must use addon, especially when the only thing you have to do is add it to the <code class="language-plaintext highlighter-rouge">Gemfile</code>!</p>


  </div><a class="u-url" href="/software/2017/12/11/activerecord-vs-sequel.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer">
  <div class="wrapper">
    <small>
      &copy; <time datetime="2025-01-20T18:00:42+00:00">2025</time>. All rights reserved.
    </small>
  </div>
</footer>
</body>

</html>
